<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OHCA Survivorship Ingest Helper</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          sans-serif;
        margin: 0;
        background: #0f172a;
        color: #e2e8f0;
      }
      header,
      main {
        max-width: 960px;
        margin: 0 auto;
        padding: 1.5rem;
      }
      textarea {
        width: 100%;
        min-height: 220px;
        border-radius: 0.75rem;
        padding: 1rem;
        border: 1px solid #334155;
        background: #0f172a;
        color: inherit;
      }
      button {
        border: none;
        border-radius: 9999px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        cursor: pointer;
      }
      .primary {
        background: #38bdf8;
        color: #0f172a;
      }
      .secondary {
        background: transparent;
        color: inherit;
        border: 1px solid #334155;
      }
      .card {
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid #1e293b;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-top: 1.5rem;
      }
      pre {
        overflow-x: auto;
        background: #020617;
        padding: 1rem;
        border-radius: 0.75rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border-bottom: 1px solid #1e293b;
        padding: 0.5rem;
        text-align: left;
      }
      .status-success {
        color: #4ade80;
      }
      .status-error {
        color: #f87171;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ajv@8.12.0/dist/ajv7.min.js"></script>
  </head>
  <body>
    <header>
      <h1>Manual ingest helper</h1>
      <p>
        Paste tab- or comma-separated records below. Use the header row names from
        <code>papers.schema.json</code> (e.g., <code>id</code>, <code>title</code>,
        <code>authors</code>, etc.). The tool validates against the schema, highlights differences
        versus the current repository data, and lets you export
        <code>papers.to-merge.json</code> for the merge script.
      </p>
      <ol>
        <li>Gather candidate records from ad-hoc database searches (PubMed, CrossRef, etc.).</li>
        <li>Paste into the input below, review validation output, and adjust fields as needed.</li>
        <li>
          Click “Export papers.to-merge.json” and run
          <code>npm run merge data/papers.to-merge.json</code> locally.
        </li>
        <li>
          Follow the <em>prep:update</em> and manual workflow_dispatch steps described in
          CONTRIBUTING.
        </li>
      </ol>
    </header>
    <main>
      <section class="card">
        <label for="raw" style="display: block; font-weight: 600; margin-bottom: 0.75rem"
          >Paste records</label
        >
        <textarea
          id="raw"
          placeholder="id\ttitle\tauthors (semicolon separated)\tjournal\tyear\tabstract\t..."
        ></textarea>
        <div style="margin-top: 1rem; display: flex; gap: 0.75rem">
          <button id="validate" class="primary">Validate &amp; compare</button>
          <button id="export" class="secondary" disabled>Export papers.to-merge.json</button>
        </div>
        <p id="status" role="status" aria-live="polite" style="margin-top: 1rem"></p>
      </section>

      <section class="card">
        <h2>Validation details</h2>
        <div id="errors"></div>
      </section>

      <section class="card">
        <h2>Diff summary vs existing data</h2>
        <div id="diff"></div>
      </section>
    </main>

    <script type="module">
      const parseInput = (text) => {
        const rows = text.trim().split(/\r?\n/).filter(Boolean);
        if (rows.length < 2) return [];
        const delimiter = rows[0].includes('\t') ? '\t' : ',';
        const headers = rows[0].split(delimiter).map((h) => h.trim());
        return rows.slice(1).map((row) => {
          const cells = row.split(delimiter);
          const record = {};
          headers.forEach((header, index) => {
            const value = cells[index]?.trim() ?? '';
            if (header === 'authors') {
              record[header] = value
                ? value
                    .split(/;|\|/)
                    .map((v) => v.trim())
                    .filter(Boolean)
                : [];
            } else if (header === 'year') {
              record[header] = value ? Number.parseInt(value, 10) : undefined;
            } else if (header === 'keywords' || header === 'mesh' || header === 'domains') {
              record[header] = value
                ? value
                    .split(/;|\|/)
                    .map((v) => v.trim())
                    .filter(Boolean)
                : [];
            } else if (header === 'links') {
              try {
                Object.assign(record, { links: JSON.parse(value || '{}') });
              } catch (error) {
                console.warn('Invalid links JSON');
              }
            } else {
              record[header] = value;
            }
          });
          return record;
        });
      };

      const ajv = new window.Ajv({ allErrors: true, strict: false });
      const schema = await fetch('../../data/papers.schema.json').then((res) => res.json());
      const validate = ajv.compile(schema);
      const existing = await fetch('../../data/papers.json').then((res) => res.json());

      const statusEl = document.getElementById('status');
      const errorsEl = document.getElementById('errors');
      const diffEl = document.getElementById('diff');
      const exportButton = document.getElementById('export');
      let lastValid = [];

      document.getElementById('validate').addEventListener('click', () => {
        errorsEl.innerHTML = '';
        diffEl.innerHTML = '';
        statusEl.textContent = '';
        const records = parseInput(document.getElementById('raw').value);
        if (!records.length) {
          statusEl.textContent = 'No records detected.';
          statusEl.className = 'status-error';
          exportButton.disabled = true;
          return;
        }
        const invalid = [];
        const validRecords = [];
        records.forEach((record, index) => {
          const data = { ...record, links: record.links ?? {} };
          if (validate(data)) {
            validRecords.push(data);
          } else {
            invalid.push({ index: index + 2, errors: validate.errors });
          }
        });
        if (invalid.length) {
          statusEl.textContent = `Validation failed for ${invalid.length} record(s).`;
          statusEl.className = 'status-error';
          errorsEl.innerHTML = invalid
            .map(
              (entry) => `
                <div>
                  <p><strong>Row ${entry.index}</strong></p>
                  <pre>${JSON.stringify(entry.errors, null, 2)}</pre>
                </div>
              `
            )
            .join('');
          exportButton.disabled = true;
          lastValid = [];
          return;
        }
        statusEl.textContent = `Validated ${validRecords.length} record(s).`;
        statusEl.className = 'status-success';
        lastValid = validRecords;
        exportButton.disabled = false;

        const existingIds = new Set(existing.map((item) => item.id));
        const newRecords = validRecords.filter((record) => !existingIds.has(record.id));
        const duplicates = validRecords.filter((record) => existingIds.has(record.id));

        diffEl.innerHTML = `
          <p><strong>${newRecords.length}</strong> new record(s) will be exported.</p>
          <p><strong>${duplicates.length}</strong> record(s) already exist and will be skipped by the merge script.</p>
          <table>
            <thead>
              <tr><th>ID</th><th>Title</th><th>Status</th></tr>
            </thead>
            <tbody>
              ${validRecords
                .map((record) => {
                  const status = existingIds.has(record.id) ? 'Already present' : 'New';
                  return `<tr><td>${record.id}</td><td>${record.title ?? ''}</td><td>${status}</td></tr>`;
                })
                .join('')}
            </tbody>
          </table>
        `;
      });

      exportButton.addEventListener('click', () => {
        if (!lastValid.length) return;
        const blob = new Blob([JSON.stringify(lastValid, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'papers.to-merge.json';
        link.click();
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>
