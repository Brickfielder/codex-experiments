---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Organisations supporting cardiac arrest survivorship research"
  description="Directory of survivorship organisations backing research, advocacy, and resources."
>
  <section class="mx-auto max-w-6xl space-y-3 px-4 pb-12 pt-6 sm:px-6 lg:px-8">
    <div class="space-y-2">
      <p class="text-xs font-semibold uppercase tracking-[0.35em] text-slate-500">
        Organisations Directory
      </p>
      <h1 class="text-3xl font-bold text-slate-900 dark:text-white sm:text-4xl">
        Organisations relevant to post-cardiac arrest research and service improvement
      </h1>
      <p class="text-base font-medium text-slate-900 dark:text-slate-50">
        Note: Inclusion implies no endorsement. Information is for signposting only.
      </p>
    </div>
  </section>

  <section class="mx-auto max-w-6xl px-4 pb-16 sm:px-6 lg:px-8">
    <div class="grid gap-8 lg:grid-cols-[260px,1fr] lg:items-start">
      <aside
        class="h-fit space-y-6 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm ring-1 ring-white/40 lg:sticky lg:top-4 dark:border-slate-800 dark:bg-slate-900 dark:ring-slate-800"
      >
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">
            Browse by country
          </p>
          <nav class="mt-4 flex flex-col gap-2" id="countryNav" aria-label="Country filters"></nav>
        </div>
        <div
          class="border-t border-slate-200 pt-4 text-sm text-slate-600 dark:border-slate-800 dark:text-slate-200"
        >
          <a
            class="inline-flex items-center gap-2 rounded-xl border border-slate-200 px-3 py-2 font-medium text-slate-700 transition hover:-translate-y-[1px] hover:border-teal-200 hover:text-teal-700 dark:border-slate-700 dark:text-slate-100 dark:hover:border-teal-500/60 dark:hover:text-teal-200"
            href="mailto:hello@caresearchhub.org"
          >
            <span aria-hidden="true">✉️</span>
            Suggest a resource
          </a>
        </div>
      </aside>

      <div class="space-y-8">
        <div class="relative">
          <input
            id="searchInput"
            class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 pl-12 text-base shadow-sm outline-none ring-1 ring-white/60 transition placeholder:text-slate-400 focus:border-teal-300 focus:ring-teal-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:ring-slate-800 dark:focus:border-teal-500 dark:focus:ring-teal-900"
            placeholder="Search resources or organisation names..."
            type="search"
            autocomplete="off"
            aria-label="Search organisations"
          />
          <svg
            aria-hidden="true"
            class="absolute left-4 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-400 dark:text-slate-500"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <button
            id="searchClear"
            class="absolute right-3 top-1/2 hidden -translate-y-1/2 rounded-full border border-slate-200 bg-white px-2 py-1 text-sm font-semibold text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-800 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200"
            type="button"
          >
            Clear
          </button>
        </div>

        <div id="resultsContainer" class="space-y-12"></div>
      </div>
    </div>
  </section>

  <script is:inline>
    const resources = [
      {
        country: { code: 'GB', name: 'United Kingdom' },
        name: 'Resuscitation Council UK — Survivor Support',
        link: 'https://www.resus.org.uk/',
        description:
          'Directory-style page linking survivors and families to clinical guidelines and support options.',
        last_verified: 'Dec 2025'
      },
      {
        country: { code: 'GB', name: 'United Kingdom' },
        name: 'Sudden Cardiac Arrest UK (SCA UK)',
        link: 'https://www.scauk.org/',
        description:
          'Peer support charity providing practical resources, a podcast, and a closed Facebook community.',
        last_verified: 'Dec 2025'
      },
      {
        country: { code: 'IT', name: 'Italy' },
        name: 'Fondazione IRC — Documenti',
        link: 'https://www.fondazioneirc.org/',
        description:
          'Downloadable psychological support guides for those who have witnessed a cardiac arrest.',
        last_verified: 'Dec 2025'
      },
      {
        country: { code: 'US', name: 'United States' },
        name: 'HeartSight',
        link: 'https://ourheartsight.com/',
        description:
          'Information and pathways to support created by and for people impacted by cardiac arrest.',
        last_verified: 'Dec 2025'
      },
      {
        country: { code: 'SE', name: 'Sweden' },
        name: 'Swedish Cardiac Arrest Survivor Network',
        link: 'https://www.hjart-lung.se/natverket-for-overlevare/',
        description:
          'Nationwide peer-support network hosted by the Swedish Heart-Lung Association.',
        last_verified: 'Dec 2025'
      },
      {
        country: { code: 'BE', name: 'Belgium' },
        name: 'The Heart Warrior Project',
        link: 'https://heartwarriorproject.com/',
        description:
          'Offers peer support, awareness events, research support, and psychological advice.',
        last_verified: 'Dec 2025'
      },
      {
        country: { code: 'US', name: 'United States' },
        name: 'Sudden Cardiac Arrest Foundation',
        link: 'https://www.sca-aware.org/',
        description:
          'Non-profit focused on raising awareness, supporting research, and providing peer communities.',
        last_verified: 'Dec 2025'
      },
      {
        country: { code: 'CH', name: 'Switzerland' },
        name: 'Swiss Heart Foundation',
        link: 'https://swissheart.ch/',
        description:
          'Provides peer support, research funding, psychological advice, and material support.',
        last_verified: 'Dec 2025'
      },
      {
        country: { code: 'FI', name: 'Finland' },
        name: 'Finnish Heart Association',
        link: 'https://sydan.fi/',
        description:
          'Association offering peer support networks and information for cardiac patients.',
        last_verified: 'Dec 2025'
      }
    ];

    const navEl = document.getElementById('countryNav');
    const containerEl = document.getElementById('resultsContainer');
    const searchInput = document.getElementById('searchInput');
    const clearButton = document.getElementById('searchClear');

    const getFlag = (code, className) => {
      if (!code || code.length !== 2) return null;
      const img = document.createElement('img');
      img.src = `https://flagcdn.com/w40/${code.toLowerCase()}.png`;
      img.alt = `${code} flag`;
      img.loading = 'lazy';
      img.className = className;
      return img;
    };

    const groupByCountry = (items) => {
      const grouped = items.reduce((acc, item) => {
        const { name } = item.country;
        if (!acc[name]) acc[name] = { ...item.country, items: [] };
        acc[name].items.push(item);
        return acc;
      }, {});
      return Object.values(grouped).sort((a, b) => a.name.localeCompare(b.name));
    };

    const createNavButton = ({ label, count, onClick, flag, active = false }) => {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = `flex items-center justify-between gap-3 rounded-xl border px-3 py-2 text-sm font-semibold transition hover:-translate-y-[1px] hover:border-teal-200 hover:text-teal-700 dark:hover:border-teal-500/60 dark:hover:text-teal-200 ${
        active
          ? 'border-teal-200 bg-white text-teal-700 shadow-sm ring-1 ring-teal-100 dark:border-teal-500/50 dark:bg-slate-900 dark:text-teal-100 dark:ring-teal-800'
          : 'border-slate-200 bg-slate-50 text-slate-700 shadow-sm ring-1 ring-white/70 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:ring-slate-800'
      }`;

      const labelWrap = document.createElement('span');
      labelWrap.className = 'flex items-center gap-2';

      if (flag) {
        flag.classList.add(
          'h-4',
          'w-6',
          'rounded',
          'object-cover',
          'ring-1',
          'ring-slate-200',
          'dark:ring-slate-700'
        );
        labelWrap.appendChild(flag);
      }

      const textSpan = document.createElement('span');
      textSpan.textContent = label;
      textSpan.className = 'whitespace-nowrap';
      labelWrap.appendChild(textSpan);

      const badge = document.createElement('span');
      badge.textContent = String(count);
      badge.className =
        'rounded-full bg-white px-2 py-0.5 text-xs font-semibold text-slate-700 ring-1 ring-inset ring-slate-200 dark:bg-slate-800 dark:text-slate-100 dark:ring-slate-700';

      button.append(labelWrap, badge);
      button.addEventListener('click', onClick);
      return button;
    };

    const renderNav = (groups, totalCountries, hasFilter) => {
      if (!navEl) return;
      navEl.innerHTML = '';

      const allButton = createNavButton({
        label: 'All countries',
        count: totalCountries,
        active: !hasFilter,
        onClick: () => resetSearch(true)
      });
      navEl.appendChild(allButton);

      groups.forEach((group) => {
        const flagImg = getFlag(group.code, '');
        const button = createNavButton({
          label: group.name,
          count: group.items.length,
          flag: flagImg,
          onClick: () => scrollToGroup(group.code)
        });
        navEl.appendChild(button);
      });
    };

    const renderCard = (item) => {
      const card = document.createElement('article');
      card.className =
        'flex h-full flex-col rounded-2xl border border-slate-200 bg-white p-5 shadow-sm transition hover:-translate-y-[2px] hover:border-teal-200 dark:border-slate-800 dark:bg-slate-900';

      const heading = document.createElement('h3');
      heading.className = 'text-lg font-semibold text-slate-900 dark:text-white';

      const link = document.createElement('a');
      link.href = item.link;
      link.target = '_blank';
      link.rel = 'noreferrer';
      link.textContent = item.name;
      link.className =
        'text-slate-900 transition hover:text-teal-700 dark:text-white dark:hover:text-teal-200';
      heading.appendChild(link);

      const description = document.createElement('p');
      description.className =
        'mt-2 flex-1 text-sm leading-relaxed text-slate-600 dark:text-slate-200';
      description.textContent = item.description;

      const footer = document.createElement('div');
      footer.className =
        'mt-4 flex items-center justify-end border-t border-dashed border-slate-200 pt-3 text-xs font-semibold text-slate-500 dark:border-slate-800 dark:text-slate-400';
      footer.textContent = `Link verified: ${item.last_verified}`;

      card.append(heading, description, footer);
      return card;
    };

    const renderResults = (groups, filterText) => {
      if (!containerEl) return;
      containerEl.innerHTML = '';

      if (groups.length === 0) {
        const empty = document.createElement('div');
        empty.className =
          'rounded-2xl border border-dashed border-slate-200 bg-white px-6 py-10 text-center text-sm font-semibold text-slate-500 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-300';
        empty.textContent = `No resources found matching "${filterText}"`;
        containerEl.appendChild(empty);
        return;
      }

      groups.forEach((group) => {
        const section = document.createElement('section');
        section.id = `group-${group.code}`;
        section.className = 'space-y-4 scroll-mt-20';

        const header = document.createElement('div');
        header.className =
          'flex items-center gap-3 border-b border-slate-200 pb-3 dark:border-slate-800';

        const flagImg = getFlag(
          group.code,
          'h-5 w-7 rounded object-cover ring-1 ring-slate-200 dark:ring-slate-700'
        );
        if (flagImg) header.appendChild(flagImg);

        const title = document.createElement('h2');
        title.className = 'text-xl font-semibold text-slate-900 dark:text-white';
        title.textContent = group.name;

        header.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'grid gap-4 sm:grid-cols-2';

        group.items.forEach((item) => {
          grid.appendChild(renderCard(item));
        });

        section.append(header, grid);
        containerEl.appendChild(section);
      });
    };

    const scrollToGroup = (code) => {
      const target = document.getElementById(`group-${code}`);
      if (!target) return;
      const offset = -80;
      const y = target.getBoundingClientRect().top + window.pageYOffset + offset;
      window.scrollTo({ top: y, behavior: 'smooth' });
    };

    const renderPage = (filterText = '') => {
      const term = filterText.trim().toLowerCase();
      if (clearButton) {
        clearButton.classList.toggle('hidden', term.length === 0);
      }

      const allGroups = groupByCountry(resources);
      const filteredGroups = allGroups
        .map((group) => {
          const matching = group.items.filter((item) => {
            const searchable = `${item.name} ${item.description}`.toLowerCase();
            return searchable.includes(term);
          });
          return { ...group, items: matching };
        })
        .filter((group) => group.items.length > 0);

      renderNav(filteredGroups, allGroups.length, term.length > 0);
      renderResults(filteredGroups, filterText);
    };

    const resetSearch = (skipScroll = false) => {
      if (searchInput) searchInput.value = '';
      renderPage('');
      if (!skipScroll) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    };

    clearButton?.addEventListener('click', () => resetSearch());
    searchInput?.addEventListener('input', (event) => {
      renderPage(event.target.value);
    });

    renderPage('');
  </script>
</BaseLayout>
