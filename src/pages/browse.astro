---
import BaseLayout from '../layouts/BaseLayout.astro';
import BrowseClient from '../components/browse/BrowseClient.tsx';
import papers from '../../data/papers.normalized.json';
import type { Paper } from '~/utils/types';
import { isInCurrentMonth } from '~/utils/dates';

const typedPapers = papers as Paper[];
const totalPapers = typedPapers.length;
const totalCountries = Array.from(
  new Set(typedPapers.map((paper) => paper.country).filter(Boolean))
).length;
const countriesThisMonth = Array.from(
  new Set(
    typedPapers
      .filter((paper) => isInCurrentMonth(paper.date))
      .map((paper) => paper.country)
      .filter(Boolean)
  )
).length;
const latestPaperDate = typedPapers.reduce<Date | null>((latest, paper) => {
  if (!paper.date) return latest;

  const parsedDate = new Date(paper.date);
  if (Number.isNaN(parsedDate.getTime())) return latest;

  if (!latest || parsedDate > latest) {
    return parsedDate;
  }

  return latest;
}, null);
const lastUpdatedLabel = latestPaperDate
  ? latestPaperDate.toLocaleString('en-US', { month: 'long', year: 'numeric' })
  : 'Unknown';

const highlightCards = [
  {
    title: 'Instant refinement',
    body: 'Use search and filters together to hone in on methods, populations, or outcomes without losing context.'
  },
  {
    title: 'Shareable states',
    body: 'Copy links with every facet preserved so collaborators can reproduce your exact view.'
  },
  {
    title: 'Signal-rich summaries',
    body: 'Domain, geography, and design details stay visible to anchor each finding inside the evidence base.'
  }
];
---

<BaseLayout
  title="Browse papers"
  description="Searchable repository of OHCA survivorship literature"
>
  <Fragment slot="hero">
    <div
      class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800/80 border border-slate-700 text-purple-200 text-xs font-semibold uppercase tracking-wider mb-6 backdrop-blur-sm"
    >
      <span class="w-2 h-2 rounded-full bg-emerald-300 animate-pulse"></span>
      Dynamic filtering workspace
    </div>
    <h1 class="text-4xl md:text-6xl font-semibold text-white tracking-tight mb-6">
      Browse the evidence base
      <span
        class="block text-transparent bg-clip-text bg-gradient-to-r from-indigo-200 via-cyan-200 to-purple-200"
      >
        Search, filter, and share
      </span>
    </h1>
    <p class="text-lg md:text-xl text-slate-300 max-w-3xl mx-auto mb-10 font-light">
      Filter by author, title, institution, country, and more. Abstracts and source links stay
      visible so you can keep the signal of each study in view while navigating the evidence trail.
    </p>
  </Fragment>

  <section class="-mt-12 -mx-6 px-6 pb-10 lg:-mx-8 lg:px-8">
    <div class="mx-auto max-w-6xl">
      <div
        class="flex flex-col gap-6 overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-2xl ring-1 ring-slate-200/80 dark:border-slate-800 dark:bg-slate-900 dark:ring-slate-800"
      >
        <div
          class="flex flex-col gap-4 border-b border-slate-100 px-6 pt-6 pb-4 md:flex-row md:items-center md:justify-between dark:border-slate-800"
        >
          <div>
            <p
              class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400"
            >
              Evidence snapshot
            </p>
            <p class="text-sm text-slate-500 dark:text-slate-300">Updated {lastUpdatedLabel}</p>
          </div>
          <span
            class="inline-flex items-center gap-2 rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-200"
          >
            <span class="h-2 w-2 rounded-full bg-emerald-400 animate-pulse"></span>
            Live feed
          </span>
        </div>
        <div class="grid gap-4 px-6 pb-6 md:grid-cols-3">
          <div class="rounded-2xl bg-slate-50 p-4 text-center shadow-sm dark:bg-slate-800/60">
            <div class="text-3xl font-bold text-slate-900 dark:text-white">
              {totalPapers.toLocaleString()}
            </div>
            <div
              class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 dark:text-slate-300"
            >
              Papers
            </div>
          </div>
          <div class="rounded-2xl bg-slate-50 p-4 text-center shadow-sm dark:bg-slate-800/60">
            <div class="text-3xl font-bold text-slate-900 dark:text-white">
              {totalCountries.toLocaleString()}
            </div>
            <div
              class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 dark:text-slate-300"
            >
              Countries
            </div>
            <p class="mt-1 text-xs text-slate-600 dark:text-slate-300">
              This month: {countriesThisMonth.toLocaleString()}
            </p>
          </div>
          <div class="rounded-2xl bg-slate-50 p-4 text-center shadow-sm dark:bg-slate-800/60">
            <div class="text-xl font-semibold text-slate-900 dark:text-white">
              {lastUpdatedLabel}
            </div>
            <div
              class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 dark:text-slate-300"
            >
              Last update
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="-mx-6 px-6 pb-14 lg:-mx-8 lg:px-8">
    <div class="mx-auto max-w-6xl space-y-10">
      <div class="grid gap-4 md:grid-cols-3">
        {
          highlightCards.map((card) => (
            <div class="rounded-2xl border border-slate-200/80 bg-white p-5 shadow-lg shadow-slate-200/60 transition hover:-translate-y-1 hover:shadow-xl dark:border-slate-800/80 dark:bg-slate-900/80 dark:shadow-none">
              <p class="text-sm font-semibold text-indigo-700 dark:text-indigo-200">{card.title}</p>
              <p class="mt-2 text-sm text-slate-600 dark:text-slate-200/90">{card.body}</p>
            </div>
          ))
        }
      </div>

      <div
        id="papers"
        class="rounded-3xl border border-slate-200/80 bg-white/95 p-6 shadow-2xl ring-1 ring-slate-100 backdrop-blur dark:border-slate-800 dark:bg-slate-900/80 dark:ring-slate-800"
      >
        <BrowseClient client:load papers={typedPapers} />
      </div>
    </div>
  </section>
</BaseLayout>
