---
import BaseLayout from '../layouts/BaseLayout.astro';
import papers from '../../data/papers.normalized.json';
import { getPaperUrl } from '~/utils/format';
import { getBrowseUrl } from '~/utils/siteUrls';
import type { Paper } from '~/utils/types';

const typedPapers = papers as Paper[];
const browseHref = getBrowseUrl();
const totalPapers = typedPapers.length;
const latestYear = typedPapers.reduce((max, paper) => Math.max(max, paper.year), 0);
const recentlyAdded = Math.min(typedPapers.length, 15);
const stats = [
  { label: 'Total Papers', value: totalPapers.toLocaleString() },
  { label: 'Latest Pub', value: latestYear },
  { label: 'New This Month', value: recentlyAdded },
  { label: 'Scope', value: 'Global' }
];
const topicSuggestions = ['Cognition', 'Anxiety', 'Caregivers'];
const recentPapers = typedPapers.slice(0, 3);

const formatBadges = (paper: Paper): string[] => {
  const pool = paper.domains?.length ? paper.domains : (paper.mesh ?? paper.keywords ?? []);
  return pool.slice(0, 3);
};

const getPrimaryExternalLink = (paper: Paper): { href: string; label: string } | null => {
  if (paper.links?.pubmed) {
    return { href: paper.links.pubmed, label: 'PubMed' };
  }
  if (paper.links?.doi) {
    return { href: paper.links.doi, label: 'DOI' };
  }
  return null;
};
---

<BaseLayout
  title="OHCA Survivorship Repository"
  description="Evidence summaries for life after cardiac arrest"
>
  <Fragment slot="hero">
    <div
      class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800/80 border border-slate-700 text-teal-400 text-xs font-semibold uppercase tracking-wider mb-6 backdrop-blur-sm"
    >
      <span class="w-2 h-2 rounded-full bg-teal-400 animate-pulse"></span>
      Live Evidence Hub
    </div>
    <h1 class="text-4xl md:text-6xl font-bold text-white tracking-tight mb-6">
      Survivorship After <br class="hidden md:block" />
      <span class="text-transparent bg-clip-text bg-gradient-to-r from-teal-200 to-cyan-400"
        >Cardiac Arrest</span
      >
    </h1>
    <p class="text-lg md:text-xl text-slate-300 max-w-2xl mx-auto mb-10 font-light">
      Mapping the evidence that tells us what life looks like <em>after</em> survival. A living collection
      of cognitive, psychological, and social outcomes.
    </p>

    <div class="max-w-2xl mx-auto relative group">
      <div
        class="absolute -inset-1 bg-gradient-to-r from-teal-500 to-cyan-500 rounded-2xl opacity-25 group-hover:opacity-50 blur transition duration-500"
      >
      </div>
      <form
        class="relative flex items-center bg-white rounded-2xl p-2 shadow-xl"
        action={browseHref}
        method="get"
      >
        <div class="pl-4 text-slate-400">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
        <label class="sr-only" htmlFor="homepage-search">Search papers</label>
        <input
          id="homepage-search"
          name="q"
          type="search"
          class="flex-1 p-3 md:p-4 outline-none text-slate-900 placeholder-slate-400"
          placeholder="Search for fatigue, cognition, return to work..."
        />
        <button
          class="bg-slate-900 text-white px-6 py-3 rounded-xl font-semibold hover:bg-slate-800 transition shadow-lg"
          type="submit"
        >
          Search
        </button>
      </form>

      <div class="mt-4 flex flex-wrap justify-center gap-2 text-sm text-slate-300">
        <span>Try:</span>
        {
          topicSuggestions.map((topic) => (
            <a
              href={`${browseHref}?q=${encodeURIComponent(topic)}`}
              class="hover:text-teal-300 border-b border-dotted border-slate-600 hover:border-teal-300"
            >
              {topic}
            </a>
          ))
        }
      </div>
    </div>
  </Fragment>

  <section
    class="-mt-12 -mx-6 divide-x divide-slate-100 overflow-hidden rounded-b-[2.5rem] border-b border-slate-200 bg-white shadow-2xl lg:-mx-8"
  >
    <div class="grid grid-cols-2 md:grid-cols-4">
      {
        stats.map((item) => (
          <div class="py-6 text-center" key={item.label}>
            <div class="text-3xl font-bold text-slate-900">{item.value}</div>
            <div class="text-xs font-semibold uppercase text-slate-400 tracking-widest mt-1">
              {item.label}
            </div>
          </div>
        ))
      }
    </div>
  </section>

  <section class="py-12 lg:py-16">
    <div class="grid grid-cols-1 gap-12 lg:grid-cols-12">
      <aside class="lg:col-span-4 space-y-8">
        <div>
          <h2 class="text-lg font-bold text-slate-900 flex items-center gap-2">
            <span class="w-1 h-6 bg-teal-500 rounded-full"></span>
            Research Domains
          </h2>
          <p class="text-sm text-slate-500 mt-2 mb-4">Filter by primary outcome domains.</p>

          <div class="grid gap-3">
            <a
              href={browseHref}
              class="group flex items-start gap-4 p-4 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-md hover:border-teal-200 hover:-translate-y-0.5 transition duration-200"
            >
              <div
                class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl group-hover:bg-indigo-600 group-hover:text-white transition"
              >
                üß†
              </div>
              <div>
                <h3 class="font-semibold text-slate-900 group-hover:text-indigo-600">Cognition</h3>
                <p class="text-xs text-slate-500 mt-1">Screening, memory, executive function.</p>
              </div>
            </a>

            <a
              href={browseHref}
              class="group flex items-start gap-4 p-4 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-md hover:border-teal-200 hover:-translate-y-0.5 transition duration-200"
            >
              <div
                class="w-10 h-10 rounded-full bg-pink-50 text-pink-600 flex items-center justify-center text-xl group-hover:bg-pink-600 group-hover:text-white transition"
              >
                ‚ù§Ô∏è
              </div>
              <div>
                <h3 class="font-semibold text-slate-900 group-hover:text-pink-600">Emotional</h3>
                <p class="text-xs text-slate-500 mt-1">Depression, anxiety, PTSD, fatigue.</p>
              </div>
            </a>

            <a
              href={browseHref}
              class="group flex items-start gap-4 p-4 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-md hover:border-teal-200 hover:-translate-y-0.5 transition duration-200"
            >
              <div
                class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center text-xl group-hover:bg-emerald-600 group-hover:text-white transition"
              >
                üå±
              </div>
              <div>
                <h3 class="font-semibold text-slate-900 group-hover:text-emerald-600">
                  Quality of Life
                </h3>
                <p class="text-xs text-slate-500 mt-1">Return to work, social participation.</p>
              </div>
            </a>
          </div>
        </div>

        <div class="bg-slate-900 rounded-2xl p-6 text-white shadow-lg">
          <h3 class="font-semibold mb-2">How we build this</h3>
          <p class="text-sm text-slate-300 leading-relaxed mb-4">
            We use a sentence-transformer model to semantic rank papers from PubMed, CINAHL, and Web
            of Science.
          </p>
          <a
            href={browseHref}
            class="text-sm font-medium text-teal-300 hover:text-teal-200 flex items-center gap-1"
          >
            Read methodology <span class="text-lg">&rarr;</span>
          </a>
        </div>
      </aside>

      <div class="lg:col-span-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-slate-900">Recent Publications</h2>
          <select
            class="text-sm border-none bg-transparent font-semibold text-slate-600 focus:ring-0 cursor-pointer"
          >
            <option>Sort by: Newest</option>
            <option>Sort by: Relevance</option>
          </select>
        </div>

        <div class="space-y-6">
          {
            recentPapers.map((paper) => {
              const badges = formatBadges(paper);
              const primaryLink = getPrimaryExternalLink(paper);
              return (
                <article
                  class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 hover:shadow-md transition group"
                  key={paper.id}
                >
                  <div class="flex items-center justify-between text-xs text-slate-500 mb-3">
                    <div class="flex items-center gap-2">
                      <span class="font-bold text-slate-700 bg-slate-100 px-2 py-1 rounded">
                        {paper.journal}
                      </span>
                      <span>{paper.year}</span>
                    </div>
                    <span class="uppercase tracking-wider font-semibold text-slate-400">
                      {paper.country || 'Global'}
                    </span>
                  </div>

                  <h3 class="text-xl font-bold text-slate-900 mb-2 leading-tight group-hover:text-teal-600 transition">
                    <a href={getPaperUrl(paper)}>{paper.title}</a>
                  </h3>

                  <p class="text-sm text-slate-600 mb-4">{paper.normalizedAuthors.join(', ')}</p>

                  <div class="flex flex-wrap gap-2 mb-4">
                    {badges.length === 0 ? (
                      <span class="px-2 py-1 rounded-md bg-slate-50 text-slate-600 text-xs font-medium border border-slate-100">
                        Evidence
                      </span>
                    ) : (
                      badges.map((badge) => (
                        <span
                          class="px-2 py-1 rounded-md bg-slate-50 text-slate-600 text-xs font-medium border border-slate-100"
                          key={`${paper.id}-${badge}`}
                        >
                          {badge}
                        </span>
                      ))
                    )}
                  </div>

                  <details class="group/abstract">
                    <summary class="flex items-center gap-2 text-sm font-semibold text-teal-600 cursor-pointer select-none hover:text-teal-800 transition">
                      <span class="block group-open/abstract:hidden">Read abstract</span>
                      <span class="hidden group-open/abstract:block">Hide abstract</span>
                      <svg
                        class="w-4 h-4 transition-transform group-open/abstract:rotate-180"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 9l-7 7-7-7"
                        />
                      </svg>
                    </summary>
                    <div class="mt-4 pt-4 border-t border-slate-100 text-sm text-slate-600 leading-relaxed space-y-2">
                      {paper.abstract ? (
                        <p>{paper.abstract}</p>
                      ) : (
                        <p class="text-slate-500">No abstract provided.</p>
                      )}
                    </div>
                  </details>

                  <div class="mt-5 flex items-center gap-4 pt-4 border-t border-slate-100">
                    <a
                      class="text-sm font-bold text-slate-900 hover:underline"
                      href={getPaperUrl(paper)}
                    >
                      View Full Details
                    </a>
                    {primaryLink && (
                      <a
                        class="text-sm font-medium text-slate-500 hover:text-blue-600 flex items-center gap-1"
                        href={primaryLink.href}
                        target="_blank"
                        rel="noreferrer"
                      >
                        {primaryLink.label}
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                          />
                        </svg>
                      </a>
                    )}
                  </div>
                </article>
              );
            })
          }
        </div>

        <div class="mt-10 flex justify-center gap-2">
          <button class="px-4 py-2 rounded-lg bg-slate-200 text-slate-500 font-semibold" disabled
            >Prev</button
          >
          <button class="px-4 py-2 rounded-lg bg-slate-900 text-white font-semibold">1</button>
          <button
            class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-700 font-semibold hover:bg-slate-50"
            >2</button
          >
          <button
            class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-700 font-semibold hover:bg-slate-50"
            >3</button
          >
          <button
            class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-700 font-semibold hover:bg-slate-50"
            >Next</button
          >
        </div>
      </div>
    </div>
  </section>
</BaseLayout>
