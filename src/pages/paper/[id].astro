---
import BaseLayout from '../../layouts/BaseLayout.astro';
import papers from '../../../data/papers.normalized.json';
import type { Paper } from '~/utils/types';
import { getPaperUrl } from '~/utils/format';
import { getPaperPermalink, getPaperSlug, parsePaperSlug } from '~/utils/siteUrls';
export const getStaticPaths = () =>
  (papers as Paper[]).map((paper) => ({ params: { id: getPaperSlug(paper.id) } }));
const typedPapers = papers as Paper[];
const slug = Astro.params.id;
const paperId = slug ? parsePaperSlug(slug) : undefined;
const paper = paperId ? typedPapers.find((item) => item.id === paperId) : undefined;
if (!paper) {
  throw Astro.response(null, { status: 404, statusText: 'Paper not found' });
}

const permalink = getPaperPermalink(paper.id);

const tokenize = (text: string) =>
  text
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, ' ')
    .split(/\s+/)
    .filter(Boolean);

const documents = typedPapers.map((item) => {
  const tokens = tokenize(item.abstract);
  const tf = new Map<string, number>();
  tokens.forEach((token) => {
    tf.set(token, (tf.get(token) ?? 0) + 1);
  });
  return { paper: item, tokens: new Set(tokens), tf };
});

const vocabulary = new Set<string>();
documents.forEach((doc) => {
  doc.tokens.forEach((token) => vocabulary.add(token));
});

const docCount = documents.length;
const idf = new Map<string, number>();
vocabulary.forEach((token) => {
  const containing = documents.filter((doc) => doc.tokens.has(token)).length;
  idf.set(token, Math.log((docCount + 1) / (containing + 1)) + 1);
});

const vectorize = (doc: { tokens: Set<string>; tf: Map<string, number> }) => {
  const vector = new Map<string, number>();
  const tokenCount = Array.from(doc.tf.values()).reduce((sum, value) => sum + value, 0);
  doc.tf.forEach((count, token) => {
    const weight = (count / tokenCount) * (idf.get(token) ?? 0);
    vector.set(token, weight);
  });
  return vector;
};

const cosine = (a: Map<string, number>, b: Map<string, number>) => {
  let dot = 0;
  let magA = 0;
  let magB = 0;
  a.forEach((value, token) => {
    if (b.has(token)) {
      dot += value * (b.get(token) ?? 0);
    }
    magA += value * value;
  });
  b.forEach((value) => {
    magB += value * value;
  });
  const denom = Math.sqrt(magA) * Math.sqrt(magB);
  return denom === 0 ? 0 : dot / denom;
};

const targetDoc = documents.find((doc) => doc.paper.id === paper.id)!;
const targetVector = vectorize(targetDoc);

const similarity = documents
  .filter((doc) => doc.paper.id !== paper.id)
  .map((doc) => ({
    paper: doc.paper,
    score: cosine(targetVector, vectorize(doc))
  }))
  .sort((a, b) => b.score - a.score);

let related = similarity
  .filter((item) => item.score > 0.05)
  .slice(0, 4)
  .map((item) => item.paper);

if (related.length === 0) {
  related = typedPapers
    .filter((doc) => doc.id !== paper.id)
    .filter((doc) => {
      const sameDomain = paper.domains?.some((domain) => doc.domains?.includes(domain)) ?? false;
      const withinYear = Math.abs(doc.year - paper.year) <= 2;
      return sameDomain && withinYear;
    })
    .slice(0, 4);
}

const makeCitation = (style: 'apa' | 'vancouver') => {
  const authors = paper.normalizedAuthors.join(style === 'apa' ? ', ' : ', ');
  const year = paper.year;
  if (style === 'apa') {
    return `${authors} (${year}). ${paper.title}. ${paper.journal}.`;
  }
  return `${authors}. ${paper.title}. ${paper.journal}. ${year}.`;
};

const makeBibtex = () =>
  `@article{${paper.id},\n  title={${paper.title}},\n  author={${paper.normalizedAuthors.join(' and ')}},\n  journal={${paper.journal}},\n  year={${paper.year}},\n  doi={${paper.doi ?? ''}}\n}`;

const makeRis = () =>
  `TY  - JOUR\nTI  - ${paper.title}\nAU  - ${paper.normalizedAuthors.join('\nAU  - ')}\nPY  - ${paper.year}\nJO  - ${paper.journal}\nDO  - ${paper.doi ?? ''}\nER  - `;
---

<BaseLayout title={paper.title} description={paper.abstract.slice(0, 140)}>
  <article class="space-y-10">
    <section
      class="page-hero rounded-3xl border border-white/70 bg-white/90 p-8 shadow-2xl ring-1 ring-indigo-100 backdrop-blur"
    >
      <p
        class="inline-flex items-center gap-2 rounded-full bg-indigo-50 px-4 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-indigo-700"
      >
        Paper profile
      </p>
      <h1 class="mt-4 text-4xl font-semibold tracking-tight text-slate-900 sm:text-5xl">
        {paper.title}
      </h1>
      <p class="mt-4 text-base text-slate-600">{paper.normalizedAuthors.join(', ')}</p>
      <div class="mt-3 flex flex-wrap items-center gap-3 text-sm font-medium text-indigo-700">
        <span
          class="rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-700"
        >
          {paper.year}
        </span>
        <span
          class="rounded-full bg-white/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-600"
        >
          {paper.journal}
        </span>
        {
          (paper.domains ?? []).map((domain) => (
            <span
              class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600"
              key={domain}
            >
              {domain}
            </span>
          ))
        }
      </div>
      <div class="page-hero-actions mt-6 flex flex-wrap gap-2 text-sm">
        {
          paper.links.pubmed && (
            <a
              class="inline-flex items-center gap-2 rounded-xl border border-indigo-100 bg-indigo-50 px-3 py-1.5 text-xs font-semibold text-indigo-700 transition hover:border-indigo-200 hover:bg-indigo-100"
              href={paper.links.pubmed}
              target="_blank"
              rel="noopener noreferrer"
            >
              PubMed
            </a>
          )
        }
        {
          paper.links.doi && (
            <a
              class="inline-flex items-center gap-2 rounded-xl border border-slate-200/80 bg-white/70 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-indigo-200 hover:text-indigo-600"
              href={paper.links.doi}
              target="_blank"
              rel="noopener noreferrer"
            >
              DOI
            </a>
          )
        }
        {
          paper.links.pmc && (
            <a
              class="inline-flex items-center gap-2 rounded-xl border border-slate-200/80 bg-white/70 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-indigo-200 hover:text-indigo-600"
              href={paper.links.pmc}
              target="_blank"
              rel="noopener noreferrer"
            >
              PMC
            </a>
          )
        }
      </div>
    </section>

    <section class="grid gap-6 lg:grid-cols-[minmax(0,2fr),minmax(0,1fr)]">
      <div
        class="min-w-0 rounded-3xl border border-white/70 bg-white/95 p-6 shadow-xl ring-1 ring-indigo-100 backdrop-blur"
      >
        <h2 class="text-xl font-semibold text-slate-900">Abstract</h2>
        <p class="mt-4 text-sm leading-relaxed text-slate-600">
          {paper.abstract}
          {
            paper.isAbstractTruncated && (
              <span class="ml-1 text-xs uppercase text-orange-600">(Abstract truncated)</span>
            )
          }
        </p>
      </div>
      <div class="min-w-0 space-y-6">
        <div
          class="rounded-3xl border border-white/70 bg-white/95 p-6 shadow-xl ring-1 ring-indigo-100 backdrop-blur"
        >
          <h2 class="text-xl font-semibold text-slate-900">Study snapshot</h2>
          <dl class="mt-4 space-y-3 text-sm text-slate-600">
            <div class="flex justify-between gap-3">
              <dt class="font-semibold text-slate-500">Setting</dt>
              <dd>{paper.setting ?? '—'}</dd>
            </div>
            <div class="flex justify-between gap-3">
              <dt class="font-semibold text-slate-500">Design</dt>
              <dd>{paper.design ?? '—'}</dd>
            </div>
            <div class="flex justify-between gap-3">
              <dt class="font-semibold text-slate-500">Country</dt>
              <dd>{paper.country ?? '—'}</dd>
            </div>
            <div class="flex justify-between gap-3">
              <dt class="font-semibold text-slate-500">Domains</dt>
              <dd class="text-right">{(paper.domains ?? []).join(', ') || '—'}</dd>
            </div>
            <div class="flex justify-between gap-3">
              <dt class="font-semibold text-slate-500">Keywords</dt>
              <dd class="text-right">{(paper.keywords ?? []).join(', ') || '—'}</dd>
            </div>
            <div class="flex justify-between gap-3">
              <dt class="font-semibold text-slate-500">MeSH</dt>
              <dd class="text-right">{(paper.mesh ?? []).join(', ') || '—'}</dd>
            </div>
          </dl>
        </div>
        <div
          class="rounded-3xl border border-white/70 bg-white/95 p-6 shadow-xl ring-1 ring-indigo-100 backdrop-blur"
        >
          <h2 class="text-xl font-semibold text-slate-900">Citations & exports</h2>
          <div class="mt-4 flex flex-wrap gap-2 text-sm">
            <button
              class="inline-flex items-center gap-2 rounded-xl border border-indigo-100 bg-indigo-50 px-3 py-1.5 text-xs font-semibold text-indigo-700 transition hover:border-indigo-200 hover:bg-indigo-100"
              type="button"
              data-copy={makeCitation('apa')}
            >
              Copy APA
            </button>
            <button
              class="inline-flex items-center gap-2 rounded-xl border border-indigo-100 bg-indigo-50 px-3 py-1.5 text-xs font-semibold text-indigo-700 transition hover:border-indigo-200 hover:bg-indigo-100"
              type="button"
              data-copy={makeCitation('vancouver')}
            >
              Copy Vancouver
            </button>
            <button
              class="inline-flex items-center gap-2 rounded-xl border border-slate-200/80 bg-white/70 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-indigo-200 hover:text-indigo-600"
              type="button"
              data-copy={makeBibtex()}
            >
              Copy BibTeX
            </button>
            <button
              class="inline-flex items-center gap-2 rounded-xl border border-slate-200/80 bg-white/70 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-indigo-200 hover:text-indigo-600"
              type="button"
              data-ris={makeRis()}
              data-filename={paper.id}
            >
              Download RIS
            </button>
          </div>
          <div class="mt-4 flex items-center gap-2 text-xs text-slate-500">
            <span class="font-semibold uppercase tracking-[0.3em] text-slate-400">Permalink</span>
            <button
              class="text-indigo-600 underline-offset-2 hover:underline"
              type="button"
              data-permalink={permalink}
            >
              Copy link
            </button>
            <span class="truncate text-slate-400">{permalink}</span>
          </div>
        </div>
      </div>
    </section>

    <section
      class="rounded-3xl border border-white/70 bg-white/90 p-6 shadow-xl ring-1 ring-indigo-100 backdrop-blur"
    >
      <h2 class="text-xl font-semibold text-slate-900">Related papers</h2>
      <div class="mt-4 grid gap-4 md:grid-cols-2">
        {
          related.map((item) => (
            <article
              class="group rounded-2xl border border-white/70 bg-white/95 p-4 shadow-lg ring-1 ring-indigo-50 transition hover:-translate-y-1 hover:shadow-2xl"
              key={item.id}
            >
              <h3 class="text-base font-semibold text-slate-900 transition group-hover:text-indigo-600">
                <a href={getPaperUrl(item)}>{item.title}</a>
              </h3>
              <p class="mt-1 text-sm text-slate-600">
                {item.normalizedAuthors.slice(0, 3).join(', ')} et al.
              </p>
              <p class="mt-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
                {item.journal} • {item.year}
              </p>
            </article>
          ))
        }
        {related.length === 0 && <p class="text-sm text-slate-600">No related papers found.</p>}
      </div>
    </section>
  </article>

  <script is:inline>
    const copyButtons = document.querySelectorAll('[data-copy]');
    copyButtons.forEach((button) => {
      button.addEventListener('click', async () => {
        const text = button.getAttribute('data-copy');
        if (!text) return;
        try {
          await navigator.clipboard.writeText(text);
          button.classList.add('bg-emerald-500', 'text-white');
          const original = button.textContent ?? '';
          button.textContent = 'Copied!';
          setTimeout(() => {
            button.classList.remove('bg-emerald-500', 'text-white');
            button.textContent = original;
          }, 1500);
        } catch (error) {
          console.error('Copy failed', error);
        }
      });
    });

    const risButton = document.querySelector('[data-ris]');
    risButton?.addEventListener('click', () => {
      const content = risButton.getAttribute('data-ris');
      if (!content) return;
      const blob = new Blob([content], { type: 'application/x-research-info-systems' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const filename = risButton.getAttribute('data-filename') ?? 'citation';
      link.download = `${encodeURIComponent(filename)}.ris`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    const permalinkButton = document.querySelector('[data-permalink]');
    permalinkButton?.addEventListener('click', async () => {
      const url = permalinkButton.getAttribute('data-permalink');
      if (!url) return;
      try {
        await navigator.clipboard.writeText(url);
        const original = permalinkButton.textContent ?? 'Copy link';
        permalinkButton.textContent = 'Link copied!';
        setTimeout(() => {
          permalinkButton.textContent = original;
        }, 1500);
      } catch (error) {
        console.error('Unable to copy permalink', error);
      }
    });
  </script>
</BaseLayout>
