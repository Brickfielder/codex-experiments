---
import {
  getAboutUrl,
  getBrowseUrl,
  getCollaborateUrl,
  getHeatmapUrl,
  getOrganisationsUrl,
  getOngoingStudiesUrl,
  getSiteUrl
} from '~/utils/siteUrls';
import '../styles/global.css';
const {
  title = 'Cardiac Arrest Research Hub',
  description = 'Knowledge hub for survivorship after cardiac arrest'
} = Astro.props;
const homeHref = getSiteUrl();
const browseHref = getBrowseUrl();
const aboutHref = getAboutUrl();
const heatmapHref = getHeatmapUrl();
const privacyHref = getSiteUrl('privacy');
const collaborateHref = getCollaborateUrl();
const organisationsHref = getOrganisationsUrl();
const ongoingStudiesHref = getOngoingStudiesUrl();
---

<!doctype html>
<html lang="en" class="min-h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="icon" type="image/png" href="/assets/icons/favicon.png" />
    <script
      data-goatcounter="https://brickfielder.goatcounter.com/count"
      async
      src="https://gc.zgo.at/count.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body
    class="min-h-screen bg-slate-50 text-slate-600 antialiased dark:bg-slate-950 dark:text-slate-100"
  >
    <a
      href="#main"
      class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:rounded-md focus:bg-teal-600 focus:px-3 focus:py-2 focus:text-white"
    >
      Skip to content
    </a>
    <header class="relative isolate overflow-visible bg-slate-900 text-white">
      <div class="absolute inset-0 bg-gradient-to-b from-slate-900 via-slate-900/95 to-slate-950">
      </div>
      <div
        class="absolute inset-0 opacity-20 bg-[radial-gradient(#2dd4bf_1px,transparent_1px)] bg-[size:40px_40px]"
      >
      </div>
      <nav class="relative border-b border-white/10">
        <div class="mx-auto flex h-16 max-w-7xl items-center justify-between px-6 lg:px-8">
          <a
            class="flex items-center gap-2 text-sm font-medium text-slate-200 transition hover:text-white"
            href={homeHref}
          >
            <span>Cardiac Arrest Research Hub</span>
          </a>
          <div class="flex items-center gap-4">
            <div
              class="hidden items-center gap-6 text-sm font-medium text-white md:flex"
              aria-label="Primary"
            >
              <a class="text-white transition hover:text-teal-200" href={homeHref}>Home</a>
              <a class="text-white transition hover:text-teal-200" href={aboutHref}
                >About the Team</a
              >
              <a class="text-white transition hover:text-teal-200" href={browseHref}>Browse</a>
              <a class="text-white transition hover:text-teal-200" href={collaborateHref}
                >Collaborate</a
              >
              <div class="relative" data-research-nav>
                <button
                  class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-white transition hover:text-teal-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-teal-300"
                  type="button"
                  aria-haspopup="menu"
                  aria-expanded="false"
                  aria-controls="research-menu-desktop"
                  data-research-toggle
                >
                  <span>Research</span>
                  <svg
                    aria-hidden="true"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="1.8"
                  >
                    <path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"></path>
                  </svg>
                </button>
                <div
                  id="research-menu-desktop"
                  class="absolute right-0 top-full z-20 mt-3 hidden w-52 rounded-2xl border border-white/10 bg-slate-900/95 p-2 shadow-2xl backdrop-blur"
                  role="menu"
                  aria-label="Research"
                  data-research-menu
                >
                  <a
                    class="block rounded-lg px-3 py-2 text-sm text-white transition hover:bg-white/10 focus:bg-white/15 focus:outline-none"
                    href={organisationsHref}
                    role="menuitem"
                    data-research-item
                  >
                    Organisations
                  </a>
                  <a
                    class="block rounded-lg px-3 py-2 text-sm text-white transition hover:bg-white/10 focus:bg-white/15 focus:outline-none"
                    href={ongoingStudiesHref}
                    role="menuitem"
                    data-research-item
                  >
                    Ongoing Studies
                  </a>
                  <a
                    class="block rounded-lg px-3 py-2 text-sm text-white transition hover:bg-white/10 focus:bg-white/15 focus:outline-none"
                    href={heatmapHref}
                    role="menuitem"
                    data-research-item
                  >
                    Research Heat Map
                  </a>
                </div>
              </div>
            </div>
            <button
              class="inline-flex items-center justify-center rounded-full border border-white/30 bg-white/10 p-2 text-white shadow-inner transition hover:border-teal-200 md:hidden"
              type="button"
              aria-label="Toggle navigation"
              data-mobile-nav
            >
              <svg
                aria-hidden="true"
                class="h-5 w-5"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h16M4 17h16"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </nav>
      {
        Astro.slots.has('hero') && (
          <div class="relative mx-auto max-w-5xl px-6 pb-20 pt-16 text-center lg:px-8">
            <slot name="hero" />
          </div>
        )
      }
    </header>
    <main id="main" class="bg-slate-50 text-slate-600 dark:bg-slate-950 dark:text-slate-100">
      <slot />
    </main>
    <footer
      class="border-t border-slate-200 bg-white py-12 dark:border-slate-800 dark:bg-slate-900"
    >
      <div class="mx-auto max-w-7xl px-6 text-center lg:px-8">
        <img
          src="/assets/icons/favicon.png"
          alt="Cardiac Arrest Research Hub logo"
          class="mx-auto mb-4 h-10 w-10"
        />
        <p class="text-sm text-slate-500 dark:text-slate-300">
          Â© {new Date().getFullYear()} Cardiac Arrest Research Hub. Built for open science.
        </p>
        <div
          class="mt-6 flex justify-center gap-6 text-sm font-medium text-slate-600 dark:text-slate-200"
        >
          <a class="transition hover:text-teal-600" href={aboutHref}>About the Team</a>
          <a class="transition hover:text-teal-600" href="mailto:hello@caresearchhub.org">
            Contact
          </a>
          <a class="transition hover:text-teal-600" href={privacyHref}>Privacy</a>
        </div>
      </div>
    </footer>
    <nav
      class="pointer-events-none fixed inset-0 z-50 hidden bg-slate-950/60 opacity-0 backdrop-blur-sm transition-opacity duration-200 md:hidden"
      aria-label="Mobile"
      data-mobile-panel
    >
      <div class="h-full w-full" data-mobile-overlay></div>
      <div
        class="absolute right-0 top-0 flex h-full w-72 translate-x-full flex-col gap-2 border-l border-white/10 bg-slate-900 px-6 py-6 text-sm font-semibold text-white shadow-2xl transition-transform duration-300 ease-out will-change-transform sm:w-80"
        data-mobile-drawer
      >
        <div class="mb-2 flex items-center justify-between">
          <span class="text-base font-semibold text-white">Menu</span>
          <button
            class="rounded-full border border-white/15 bg-white/5 p-2 text-white transition hover:border-white/30 hover:bg-white/10"
            type="button"
            aria-label="Close navigation"
            data-mobile-close
          >
            <svg
              aria-hidden="true"
              class="h-4 w-4"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M6 18L18 6"></path>
            </svg>
          </button>
        </div>
        <div class="flex flex-col divide-y divide-white/10">
          <a class="px-1 py-3 text-left text-white transition hover:text-teal-200" href={homeHref}
            >Home</a
          >
          <a class="px-1 py-3 text-left text-white transition hover:text-teal-200" href={aboutHref}
            >About the Team</a
          >
          <a class="px-1 py-3 text-left text-white transition hover:text-teal-200" href={browseHref}
            >Browse</a
          >
          <a
            class="px-1 py-3 text-left text-white transition hover:text-teal-200"
            href={collaborateHref}>Collaborate</a
          >
          <div class="py-1" data-research-nav>
            <button
              class="flex w-full items-center justify-between rounded-lg px-1 py-3 text-left text-white transition hover:text-teal-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-teal-300"
              type="button"
              aria-haspopup="menu"
              aria-expanded="false"
              aria-controls="research-menu-mobile"
              data-research-toggle
            >
              <span>Research</span>
              <svg
                aria-hidden="true"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="1.8"
              >
                <path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </button>
            <div
              id="research-menu-mobile"
              class="mt-2 hidden flex-col gap-1 rounded-xl border border-white/10 bg-white/5 p-2"
              role="menu"
              aria-label="Research"
              data-research-menu
            >
              <a
                class="block rounded-lg px-3 py-2 text-sm text-white transition hover:bg-white/10 focus:bg-white/15 focus:outline-none"
                href={organisationsHref}
                role="menuitem"
                data-research-item
              >
                Organisations
              </a>
              <a
                class="block rounded-lg px-3 py-2 text-sm text-white transition hover:bg-white/10 focus:bg-white/15 focus:outline-none"
                href={ongoingStudiesHref}
                role="menuitem"
                data-research-item
              >
                Ongoing Studies
              </a>
              <a
                class="block rounded-lg px-3 py-2 text-sm text-white transition hover:bg-white/10 focus:bg-white/15 focus:outline-none"
                href={heatmapHref}
                role="menuitem"
                data-research-item
              >
                Research Heat Map
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <script is:inline>
      const mobileToggle = document.querySelector('[data-mobile-nav]');
      const mobilePanel = document.querySelector('[data-mobile-panel]');
      const mobileDrawer = document.querySelector('[data-mobile-drawer]');
      const mobileOverlay = document.querySelector('[data-mobile-overlay]');
      const mobileClose = document.querySelector('[data-mobile-close]');

      const openMobileNav = () => {
        if (!mobilePanel || !mobileDrawer || !mobileToggle) return;
        mobilePanel.classList.remove('hidden');
        window.requestAnimationFrame(() => {
          mobilePanel.classList.remove('opacity-0');
          mobilePanel.classList.remove('pointer-events-none');
          mobileDrawer.classList.remove('translate-x-full');
          mobileToggle.setAttribute('aria-expanded', 'true');
        });
      };

      const closeMobileNav = () => {
        if (!mobilePanel || !mobileDrawer || !mobileToggle) return;
        mobilePanel.classList.add('opacity-0');
        mobilePanel.classList.add('pointer-events-none');
        mobileDrawer.classList.add('translate-x-full');
        mobileToggle.setAttribute('aria-expanded', 'false');
        window.setTimeout(() => mobilePanel.classList.add('hidden'), 200);
      };

      mobileToggle?.addEventListener('click', openMobileNav);
      mobileOverlay?.addEventListener('click', closeMobileNav);
      mobileClose?.addEventListener('click', closeMobileNav);
      mobilePanel?.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', closeMobileNav);
      });
      mobilePanel?.addEventListener('keyup', (event) => {
        if (event.key === 'Escape') closeMobileNav();
      });
    </script>
    <script is:inline>
      const researchNavs = Array.from(document.querySelectorAll('[data-research-nav]'));

      const setMenuVisibility = (nav, isOpen) => {
        const button = nav.querySelector('[data-research-toggle]');
        const menu = nav.querySelector('[data-research-menu]');
        if (!button || !menu) return;
        button.setAttribute('aria-expanded', String(isOpen));
        nav.dataset.open = isOpen ? 'true' : 'false';
        menu.classList.toggle('hidden', !isOpen);
      };

      const closeAllResearchNavs = () => {
        researchNavs.forEach((nav) => setMenuVisibility(nav, false));
      };

      const focusFirstMenuItem = (nav) => {
        const firstItem = nav.querySelector('[data-research-item]');
        firstItem?.focus();
      };

      const moveFocus = (items, current, delta) => {
        const index = items.indexOf(current);
        if (index === -1) return;
        const nextItem = items[(index + delta + items.length) % items.length];
        nextItem?.focus();
      };

      researchNavs.forEach((nav) => {
        const button = nav.querySelector('[data-research-toggle]');
        const menu = nav.querySelector('[data-research-menu]');
        const menuItems = Array.from(nav.querySelectorAll('[data-research-item]'));

        if (!button || !menu) return;

        button.addEventListener('click', (event) => {
          event.preventDefault();
          const isOpen = nav.dataset.open === 'true';
          closeAllResearchNavs();
          setMenuVisibility(nav, !isOpen);
        });

        button.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            const isOpen = nav.dataset.open === 'true';
            closeAllResearchNavs();
            const nextState = !isOpen;
            setMenuVisibility(nav, nextState);
            if (nextState) focusFirstMenuItem(nav);
          }

          if (event.key === 'ArrowDown') {
            event.preventDefault();
            closeAllResearchNavs();
            setMenuVisibility(nav, true);
            focusFirstMenuItem(nav);
          }

          if (event.key === 'Escape') {
            setMenuVisibility(nav, false);
            button.focus();
          }
        });

        menu.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            event.preventDefault();
            setMenuVisibility(nav, false);
            button.focus();
          }
        });

        menuItems.forEach((item) => {
          item.addEventListener('click', () => closeAllResearchNavs());

          item.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowDown') {
              event.preventDefault();
              moveFocus(menuItems, item, 1);
            }

            if (event.key === 'ArrowUp') {
              event.preventDefault();
              moveFocus(menuItems, item, -1);
            }
          });
        });
      });

      document.addEventListener('click', (event) => {
        researchNavs.forEach((nav) => {
          if (nav.dataset.open === 'true' && !nav.contains(event.target)) {
            setMenuVisibility(nav, false);
          }
        });
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') closeAllResearchNavs();
      });

      window.addEventListener('astro:after-swap', closeAllResearchNavs);
    </script>
  </body>
</html>
