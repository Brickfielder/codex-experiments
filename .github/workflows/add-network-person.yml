name: Add Resuscitation Network Person

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Full name'
        required: true
        type: string
      email:
        description: 'Primary contact email'
        required: true
        type: string
      role:
        description: 'Role/title'
        required: true
        type: string
      org:
        description: 'Affiliation or organization'
        required: true
        type: string
      city:
        description: 'City'
        required: true
        type: string
      country:
        description: 'Country'
        required: true
        type: string
      interests:
        description: 'Focus areas (optional)'
        required: false
        type: string
        default: ''
      tags:
        description: 'Comma or newline separated tags (optional)'
        required: false
        type: string
        default: ''
      offer:
        description: 'What I can offer (optional)'
        required: false
        type: string
        default: ''
      looking_to_collaborate_on:
        description: 'Looking to collaborate on (optional)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  add-person:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR automation token availability
        env:
          PR_AUTOMATION_TOKEN: ${{ secrets.ACTIONS_PR_TOKEN }}
        run: |
          if [ -z "$PR_AUTOMATION_TOKEN" ]; then
            echo "::warning::The ACTIONS_PR_TOKEN secret is not configured. Falling back to the workflow GITHUB_TOKEN."
            echo "::notice::Add a fine-grained personal access token with Contents: Read & Write and Pull requests: Read & Write scopes to secrets as ACTIONS_PR_TOKEN so workflows can open pull requests without additional repository settings."
            echo "::notice::Alternatively, enable the repository setting 'Allow GitHub Actions to create and approve pull requests' to allow the fallback token to create PRs."
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci

      - name: Prepare metadata
        id: meta
        run: |
          slug=$(echo "${{ inputs.name }}" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g; s/-+/-/g')
          if [ -z "$slug" ]; then
            slug="network-person"
          fi
          echo "slug=$slug" >> "$GITHUB_OUTPUT"

      - name: Add person entry
        env:
          PERSON_NAME: ${{ inputs.name }}
          PERSON_EMAIL: ${{ inputs.email }}
          PERSON_ROLE: ${{ inputs.role }}
          PERSON_ORG: ${{ inputs.org }}
          PERSON_CITY: ${{ inputs.city }}
          PERSON_COUNTRY: ${{ inputs.country }}
          PERSON_INTERESTS: ${{ inputs.interests }}
          PERSON_TAGS: ${{ inputs.tags }}
          PERSON_OFFER: ${{ inputs.offer }}
          PERSON_LOOKING_TO_COLLABORATE_ON: ${{ inputs.looking_to_collaborate_on }}
        run: |
          set -euo pipefail
          npm run add:network-person -- \
            --name "$PERSON_NAME" \
            --email "$PERSON_EMAIL" \
            --role "$PERSON_ROLE" \
            --org "$PERSON_ORG" \
            --city "$PERSON_CITY" \
            --country "$PERSON_COUNTRY" \
            --interests "$PERSON_INTERESTS" \
            --tags "$PERSON_TAGS" \
            --offer "$PERSON_OFFER" \
            --looking_to_collaborate_on "$PERSON_LOOKING_TO_COLLABORATE_ON"

      - name: Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.ACTIONS_PR_TOKEN || github.token }}
          branch: chore/network-person/${{ steps.meta.outputs.slug }}
          commit-message: 'feat: add resuscitation network person'
          title: 'Add ${{ inputs.name }} to resuscitation network'
          body: |
            ## Summary
            - Adds ${{ inputs.name }} to data/resuscitation-network-people.json

            Generated via workflow_dispatch.
          signoff: false
