name: Bulk add papers to repository

permissions:
  contents: write
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      identifiers:
        description: Newline-separated list of DOIs
        required: true
      preview_only:
        description: true=donâ€™t update datasets, just validate
        required: true
        default: "true"

jobs:
  bulk-add:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check PR automation token availability
        env:
          PR_AUTOMATION_TOKEN: ${{ secrets.ACTIONS_PR_TOKEN }}
        run: |
          if [ -z "$PR_AUTOMATION_TOKEN" ]; then
            echo "::warning::The ACTIONS_PR_TOKEN secret is not configured. Falling back to the workflow GITHUB_TOKEN."
            echo "::notice::Add a fine-grained personal access token with Contents: Read & Write and Pull requests: Read & Write scopes to secrets as ACTIONS_PR_TOKEN so workflows can open pull requests without additional repository settings."
            echo "::notice::Alternatively, enable the repository setting 'Allow GitHub Actions to create and approve pull requests' to allow the fallback token to create PRs."
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm ci

      - name: Prepare DOI list
        id: doi_inputs
        env:
          IDENTIFIERS: ${{ github.event.inputs.identifiers }}
        run: |
          set -euo pipefail
          sanitized=$(printf '%s\n' "$IDENTIFIERS" | tr '\r' '\n')
          mapfile -t dois < <(printf '%s\n' "$sanitized" | sed 's/^[ \t]*//;s/[ \t]*$//' | awk 'length>0')
          if [ "${#dois[@]}" -eq 0 ]; then
            echo "No DOIs provided" >&2
            exit 1
          fi
          {
            echo "count=${#dois[@]}"
            printf 'list<<EOF\n'
            printf '%s\n' "${dois[@]}"
            echo 'EOF'
            printf 'first=%s\n' "${dois[0]}"
          } >> "$GITHUB_OUTPUT"

      - name: Run bulk add:paper
        env:
          NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
          PREVIEW_ONLY: ${{ github.event.inputs.preview_only }}
        run: |
          set -euo pipefail
          preview=$(printf '%s\n' "$PREVIEW_ONLY" | tr '[:upper:]' '[:lower:]')
          while IFS= read -r doi; do
            [ -z "$doi" ] && continue
            echo "Adding DOI: $doi"
            npm run add:paper -- --doi "$doi" --preview "$preview"
          done <<'DOILIST'
${{ steps.doi_inputs.outputs.list }}
DOILIST

      - name: Create PR with changes
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.ACTIONS_PR_TOKEN || github.token }}
          commit-message: "chore: bulk add ${{ steps.doi_inputs.outputs.count }} papers"
          branch: chore/bulk-add-papers-${{ github.run_id }}
          title: "Bulk add papers (${{ steps.doi_inputs.outputs.count }})"
          body: |
            Automated bulk addition.
            Preview=${{ github.event.inputs.preview_only }}
            First DOI=${{ steps.doi_inputs.outputs.first }}
          delete-branch: true
